parameters:
    - name: DeployEnv
      type: string
    - name: DownloadFromPipeline
      type: string
      default: ''
    - name: DeployPreviewName
      type: string
      default: ''
    - name: DeployApiToken
      type: string
    - name: DeployUrl
      type: string
    - name: GithubAppPrivateKeyBase64
      type: string

steps:
    - download: ${{ coalesce(parameters.DownloadFromPipeline, 'current') }}
      artifact: build
      displayName: Download artifact

    - script: cp ./src/env/${{ parameters.DeployEnv }}-config.json $(Pipeline.Workspace)/${{ coalesce(parameters.DownloadFromPipeline, '.') }}/build/env-config.json
      displayName: Setup env

    - task: AzureStaticWebApp@0
      inputs:
          cwd: $(Pipeline.Workspace)/${{ coalesce(parameters.DownloadFromPipeline, '.') }}
          skip_app_build: true
          app_location: ./build
          api_location: ''
          deployment_environment: ${{ parameters.DeployPreviewName }}
          output_location: ''
          azure_static_web_apps_api_token: ${{ parameters.DeployApiToken }}
      displayName: Deploy Azure Static Web App

    - script: |
          ./azure-devops/github-cli/script.sh deployment \
              --privateKeyBase64 "$GITHUB_APP_PRIVATE_KEY_BASE64" \
              --environment "$ENVIRONMENT" \
              --ref "$(git rev-parse HEAD)" \
              --deployedUrl "$DEPLOY_URL" \
              --previewEnvName "$DEPLOY_PREVIEW_NAME"
      displayName: Create deployment in GitHub
      env:
          ENVIRONMENT: ${{ coalesce(parameters.DeployPreviewName, parameters.DeployEnv) }}
          DEPLOY_URL: ${{ parameters.DeployUrl }}
          DEPLOY_PREVIEW_NAME: ${{ parameters.DeployPreviewName }}
          GITHUB_APP_PRIVATE_KEY_BASE64: ${{ parameters.GithubAppPrivateKeyBase64 }}
